@{
	ViewData["Title"] = "Dashboard 1";
}

@section Styles {
	<link rel="stylesheet" href="~/css/dashboard.css" />
}

<h2 class="text-center">Histórico de Temperatura de Estufa</h2>

<div>
	<div class="d-inline-flex w-100 justify-content-center align-items-center mb-3 mt-3">
		<div class="d-flex align-items-center">
			<label class="col-form-label mr-2">Data inicial</label>
			<input class="form-control w-auto" type="date" id="dataInicio" />
		</div>
		<div class="d-flex align-items-center ml-4 mr-4">
			<label class="col-form-label mr-2">Data final</label>
			<input class="form-control w-auto" type="date" id="dataFim" />
		</div>
		<select id="Estufa" name="Estufa" asp-items="ViewBag.Estufas" class="form-control w-25 mr-1"></select>
		<input type="button" class="filter-btn start ml-1" onclick="iniciaChart()" />
	</div>
</div>

<canvas id="temperatureChart" width="1000" height="450" style="background-color: white;"></canvas>

@section Scripts {
	<script src="~/js/dashboard.js"></script>
	<script>
		const estufas = @Html.Raw(ViewBag.JsonEstufas);
		let estufaSelecionada;
		let dataInicio;
		let dataFim;

		let temperatureChart; // canvas do gráfico

		// pontos no gráfico
		let pontosAcumulados = [];
		const annotations = {}

		function montaChart() {
			const ctx = document.getElementById('temperatureChart').getContext('2d');
			temperatureChart = montaInstanciaDeGrafico(ctx, pontosAcumulados, annotations);
		}

		// iniciliza a montagem dos dados no gráfico
		function iniciaChart() {
			// limpa todos os pontos
			pontosAcumulados.splice(0, pontosAcumulados.length);

			const idEstufaSelecionada = document.getElementById('Estufa').value;
			estufaSelecionada = estufas.find(e => e.Id == idEstufaSelecionada);
			
			dataInicio = document.getElementById('dataInicio').value;
			dataFim = document.getElementById('dataFim').value;

			montaRangesTemperatura(annotations, estufaSelecionada.TemperaturaMinima, estufaSelecionada.TemperaturaMaxima);
			updateChart();
		}

		// carrega os dados do Fiware no gráfico
		function updateChart() {
			$.ajax({
				url: `@(Url.Action("DadosHistoricosDispositivo", "Dashboards"))?entityNameID=${estufaSelecionada.Medidor.Id}&dataInicio=${dataInicio}&dataFim=${dataFim}`,
				method: 'GET',
				success: function (data) {
					const dadosNaRequisicao = JSON.parse(data).contextResponses[0].contextElement.attributes[0].values
					insereDadosNoGrafico(dadosNaRequisicao);
					temperatureChart.update();
				}
			});
		}

		function insereDadosNoGrafico(dados) {
			pontosAcumulados.splice(0, pontosAcumulados.length);
			dados.forEach(d => {
				pontosAcumulados.push({
					x: new Date(d.recvTime),
					y: d.attrValue
				});
			});
		}
	</script>
}